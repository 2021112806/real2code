# æ¨¡å‹æ¨ç†ä½¿ç”¨æŒ‡å—

## ğŸ“ æ–‡ä»¶è¯´æ˜

### 1. sample_bbox.json
åŒ…å«3ä¸ªæµ‹è¯•æ ·æœ¬çš„OBBæ•°æ®ï¼š
- **StorageFurniture_simple**: ç®€å•æ ·æœ¬ï¼ˆ2ä¸ªéƒ¨ä»¶ï¼š1é—¨+1ä¸»ä½“ï¼‰
- **StorageFurniture_48177**: ä¸­ç­‰å¤æ‚åº¦ï¼ˆ3ä¸ªéƒ¨ä»¶ï¼š2é—¨+1ä¸»ä½“ï¼‰
- **StorageFurniture_complex**: å¤æ‚æ ·æœ¬ï¼ˆ7ä¸ªéƒ¨ä»¶ï¼š6é—¨+1ä¸»ä½“ï¼‰

æ¯ä¸ªæ ·æœ¬åŒ…å«ï¼š
- `description`: æ ·æœ¬æè¿°
- `bbox_code`: OBBè¾“å…¥æ•°æ®
- `expected_output`: æœŸæœ›çš„æ¨¡å‹è¾“å‡ºï¼ˆç”¨äºå¯¹æ¯”ï¼‰

### 2. run_inference.py â­ (æ¨è)
**ä¸“é—¨ä¸º `sample_bbox.json` è®¾è®¡çš„æ¨ç†è„šæœ¬**ï¼Œæ”¯æŒï¼š
- âœ… è‡ªåŠ¨åŠ è½½`sample_bbox.json`
- âœ… æ‰¹é‡æµ‹è¯•å¤šä¸ªæ ·æœ¬
- âœ… å¯¹æ¯”æœŸæœ›è¾“å‡º
- âœ… ä¿å­˜è¯¦ç»†ç»“æœ

âš ï¸ **é‡è¦**: è¯·ä½¿ç”¨æ­¤è„šæœ¬æ¥æµ‹è¯• `sample_bbox.json`ï¼

### 3. inference_example.py
é€šç”¨æ¨ç†è„šæœ¬ï¼ˆä¸æ”¯æŒ `sample_bbox.json` æ ¼å¼ï¼Œé€‚åˆè‡ªå®šä¹‰ä½¿ç”¨ï¼‰

å¦‚éœ€äº†è§£ä¸¤ä¸ªè„šæœ¬çš„åŒºåˆ«ï¼Œè¯·æŸ¥çœ‹ `INFERENCE_SCRIPTS_COMPARISON.md`

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1: ç¡®ä¿è®­ç»ƒå®Œæˆ
è®­ç»ƒè„šæœ¬ä¼šåœ¨`code-llama-shape-ft/`ç›®å½•ä¸‹ä¿å­˜æ£€æŸ¥ç‚¹ï¼š
```bash
ls code-llama-shape-ft/
# åº”è¯¥çœ‹åˆ°: checkpoint-100, checkpoint-200, checkpoint-300, checkpoint-400
```

### æ­¥éª¤2: ä½¿ç”¨å¾®è°ƒåçš„æ¨¡å‹è¿›è¡Œæ¨ç†

#### æµ‹è¯•æ‰€æœ‰æ ·æœ¬ï¼ˆæ¨èï¼‰
```bash
python run_inference.py \
  --lora_model code-llama-shape-ft/checkpoint-400
```

#### æµ‹è¯•å•ä¸ªæ ·æœ¬
```bash
# æµ‹è¯•ç®€å•æ ·æœ¬
python run_inference.py \
  --lora_model code-llama-shape-ft/checkpoint-400 \
  --sample_name StorageFurniture_simple

# æµ‹è¯•å¤æ‚æ ·æœ¬
python run_inference.py \
  --lora_model code-llama-shape-ft/checkpoint-400 \
  --sample_name StorageFurniture_complex
```

#### å¯¹æ¯”åŸºç¡€æ¨¡å‹å’Œå¾®è°ƒæ¨¡å‹
```bash
# 1. æµ‹è¯•åŸºç¡€æ¨¡å‹ï¼ˆæœªå¾®è°ƒï¼‰
python run_inference.py --output_file results_base.txt

# 2. æµ‹è¯•å¾®è°ƒæ¨¡å‹
python run_inference.py \
  --lora_model code-llama-shape-ft/checkpoint-400 \
  --output_file results_finetuned.txt

# 3. å¯¹æ¯”ä¸¤ä¸ªæ–‡ä»¶
diff results_base.txt results_finetuned.txt
```

---

## ğŸ“Š å‚æ•°è¯´æ˜

### å¿…éœ€å‚æ•°
- `--base_model`: åŸºç¡€æ¨¡å‹è·¯å¾„ï¼ˆé»˜è®¤: `/mnt/data/zhangzhaodong/real2code/models/codellama-7b`ï¼‰

### å¯é€‰å‚æ•°
- `--lora_model`: LoRAæƒé‡è·¯å¾„ï¼ˆä¾‹å¦‚: `code-llama-shape-ft/checkpoint-400`ï¼‰
- `--sample_file`: æ ·æœ¬æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤: `sample_bbox.json`ï¼‰
- `--sample_name`: æŒ‡å®šæµ‹è¯•çš„æ ·æœ¬åç§°ï¼ˆé»˜è®¤: æµ‹è¯•æ‰€æœ‰æ ·æœ¬ï¼‰
- `--max_new_tokens`: æœ€å¤§ç”Ÿæˆtokenæ•°ï¼ˆé»˜è®¤: 256ï¼‰
- `--temperature`: é‡‡æ ·æ¸©åº¦ï¼ˆé»˜è®¤: 0.1ï¼ŒèŒƒå›´: 0.0-1.0ï¼‰
  - 0.0: è´ªå©ªè§£ç ï¼ˆæœ€ç¡®å®šï¼‰
  - 0.1-0.3: ä½æ¸©åº¦ï¼ˆæ¨èï¼Œç¨³å®šä½†æœ‰ä¸€å®šå¤šæ ·æ€§ï¼‰
  - 0.5-0.7: ä¸­æ¸©åº¦ï¼ˆæ›´å¤šå˜åŒ–ï¼‰
  - 1.0: é«˜æ¸©åº¦ï¼ˆæœ€éšæœºï¼‰
- `--output_file`: ç»“æœä¿å­˜æ–‡ä»¶ï¼ˆé»˜è®¤: `inference_results.txt`ï¼‰

---

## ğŸ“ è¾“å‡ºæ ¼å¼

### ç»ˆç«¯è¾“å‡ºç¤ºä¾‹
```
================================================================================
ğŸ¤– CodeLlama å…³èŠ‚ä»£ç ç”Ÿæˆæ¨ç†
================================================================================

åŠ è½½åŸºç¡€æ¨¡å‹: /mnt/data/zhangzhaodong/real2code/models/codellama-7b
åŠ è½½LoRAæƒé‡: code-llama-shape-ft/checkpoint-400
âœ“ ä½¿ç”¨å¾®è°ƒåçš„æ¨¡å‹
æ¨¡å‹åŠ è½½å®Œæˆ

ğŸ“‹ å°†æµ‹è¯• 3 ä¸ªæ ·æœ¬

================================================================================
ğŸ” æµ‹è¯•æ ·æœ¬: StorageFurniture_simple
================================================================================
è¯´æ˜: ä¸€ä¸ªç®€å•çš„å­˜å‚¨å®¶å…·æ ·æœ¬ï¼ŒåŒ…å«2ä¸ªéƒ¨ä»¶ï¼š1ä¸ªé—¨å’Œ1ä¸ªä¸»ä½“

ğŸ“¥ è¾“å…¥OBBä»£ç :
--------------------------------------------------------------------------------
bboxes={
0:{'center':[-0.59,0.0,0.06],'R':[[-1.0,0.3,0.0],[0.3,1.0,0.0],[0.0,0.0,1.0]],'extent':[0.09,0.82,1.16]},
1:{'center':[0.06,0.0,-0.02],'R':[[1.0,0.0,0.0],[0.0,1.0,0.0],[0.0,0.0,1.0]],'extent':[1.0,0.87,1.43]},
}
--------------------------------------------------------------------------------

âš™ï¸  æ­£åœ¨ç”Ÿæˆ...

================================================================================
ğŸ“Š ç»“æœæ¯”è¾ƒ
================================================================================

æœŸæœ›è¾“å‡º:
--------------------------------------------------------------------------------
root_geom = 1
child_joints = [
dict(box=0,type='hinge',idx=1,edge=[-0.38, 0.48],sign=-1),
]

å®é™…ç”Ÿæˆ:
--------------------------------------------------------------------------------
root_geom = 1
child_joints = [
dict(box=0,type='hinge',idx=1,edge=[-0.38, 0.48],sign=-1),
]

================================================================================
âœ… å®Œå…¨åŒ¹é…ï¼
================================================================================
```

### ä¿å­˜çš„æ–‡ä»¶å†…å®¹
`inference_results.txt` åŒ…å«ï¼š
- æ¨¡å‹ä¿¡æ¯
- æ¯ä¸ªæ ·æœ¬çš„è¾“å…¥ã€æœŸæœ›è¾“å‡ºã€å®é™…è¾“å‡º
- ä¾¿äºåç»­åˆ†æå’Œå¯¹æ¯”

---

## ğŸ” å¦‚ä½•è¯„ä¼°æ¨¡å‹æ•ˆæœ

### 1. æŸ¥çœ‹åŒ¹é…åº¦
è„šæœ¬ä¼šè‡ªåŠ¨æ¯”è¾ƒï¼š
- âœ… root_geom æ˜¯å¦åŒ¹é…
- âœ… child_joints æ•°é‡æ˜¯å¦åŒ¹é…
- âœ… æ•´ä½“è¾“å‡ºæ ¼å¼æ˜¯å¦æ­£ç¡®

### 2. è¯„ä¼°æŒ‡æ ‡
- **å®Œå…¨åŒ¹é…**: ç”Ÿæˆçš„ä»£ç ä¸æœŸæœ›å®Œå…¨ä¸€è‡´ï¼ˆæœ€ä½³ï¼‰
- **éƒ¨åˆ†åŒ¹é…**: root_geomæ­£ç¡®ï¼Œå…³èŠ‚æ•°é‡æ­£ç¡®ï¼ˆè‰¯å¥½ï¼‰
- **ä¸åŒ¹é…**: å…³é”®ä¿¡æ¯é”™è¯¯ï¼ˆéœ€è¦ç»§ç»­è®­ç»ƒï¼‰

### 3. å¯¹æ¯”ä¸åŒæ£€æŸ¥ç‚¹
```bash
# æµ‹è¯•checkpoint-100
python run_inference.py \
  --lora_model code-llama-shape-ft/checkpoint-100 \
  --output_file results_100.txt

# æµ‹è¯•checkpoint-200
python run_inference.py \
  --lora_model code-llama-shape-ft/checkpoint-200 \
  --output_file results_200.txt

# æµ‹è¯•checkpoint-400ï¼ˆæœ€ç»ˆï¼‰
python run_inference.py \
  --lora_model code-llama-shape-ft/checkpoint-400 \
  --output_file results_400.txt
```

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. ä½¿ç”¨è‡ªå®šä¹‰æ ·æœ¬

åˆ›å»ºä½ è‡ªå·±çš„JSONæ–‡ä»¶ï¼š
```json
{
  "my_sample": {
    "description": "æˆ‘çš„æµ‹è¯•æ ·æœ¬",
    "obb_rel": {
      "bbox_code": "bboxes={\n0:{'center':[0,0,0],'R':[[1,0,0],[0,1,0],[0,0,1]],'extent':[1,1,1]},\n}",
      "expected_output": "root_geom = 0\nchild_joints = []"
    }
  }
}
```

ç„¶åè¿è¡Œï¼š
```bash
python run_inference.py \
  --lora_model code-llama-shape-ft/checkpoint-400 \
  --sample_file my_sample.json
```

### 2. è°ƒæ•´ç”Ÿæˆå‚æ•°

**æ›´ç¡®å®šçš„è¾“å‡º**ï¼ˆä½æ¸©åº¦ï¼‰:
```bash
python run_inference.py \
  --lora_model code-llama-shape-ft/checkpoint-400 \
  --temperature 0.0
```

**æ›´å¤šæ ·åŒ–çš„è¾“å‡º**ï¼ˆé«˜æ¸©åº¦ï¼‰:
```bash
python run_inference.py \
  --lora_model code-llama-shape-ft/checkpoint-400 \
  --temperature 0.7
```

### 3. æ‰¹å¤„ç†å¤šä¸ªæ–‡ä»¶

```bash
#!/bin/bash
# æµ‹è¯•å¤šä¸ªæ£€æŸ¥ç‚¹
for checkpoint in 100 200 300 400; do
  echo "æµ‹è¯• checkpoint-${checkpoint}..."
  python run_inference.py \
    --lora_model code-llama-shape-ft/checkpoint-${checkpoint} \
    --output_file results_${checkpoint}.txt
done
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. æ‰¾ä¸åˆ°checkpoint
```
âŒ é”™è¯¯: LoRAæƒé‡ä¸å­˜åœ¨: code-llama-shape-ft/checkpoint-400
```
**è§£å†³**: ç¡®è®¤è®­ç»ƒå·²å®Œæˆï¼Œæ£€æŸ¥ç›®å½•ï¼š
```bash
ls code-llama-shape-ft/
```

### 2. CUDA Out of Memory
æ¨ç†æ—¶æ˜¾å­˜ä¸è¶³ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ä½¿ç”¨å•GPU
CUDA_VISIBLE_DEVICES=0 python run_inference.py --lora_model ...

# æˆ–è€…åœ¨è„šæœ¬ä¸­å·²ç»è®¾ç½®äº†æ›´å°çš„batch size
```

### 3. ç”Ÿæˆç»“æœä¸ç†æƒ³
- æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„checkpointï¼ˆé€šå¸¸æœ€åçš„æœ€å¥½ï¼‰
- å°è¯•è°ƒæ•´temperatureï¼ˆ0.0-0.3é€šå¸¸æœ€ç¨³å®šï¼‰
- æŸ¥çœ‹è®­ç»ƒæ—¥å¿—ï¼Œç¡®è®¤lossæ˜¯å¦æ”¶æ•›

### 4. ç”Ÿæˆé€Ÿåº¦æ…¢
è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºï¼š
- CodeLlama-7Bæ˜¯å¤§æ¨¡å‹
- æ¨ç†æ˜¯åºåˆ—ç”Ÿæˆï¼Œéœ€è¦é€tokenç”Ÿæˆ
- é¢„æœŸé€Ÿåº¦ï¼š~10-30ç§’/æ ·æœ¬ï¼ˆå–å†³äºGPUï¼‰

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥

1. **è¯„ä¼°æ¨¡å‹æ•ˆæœ**: è¿è¡Œæ¨ç†ï¼ŒæŸ¥çœ‹ç»“æœ
2. **åˆ†æé”™è¯¯**: å¦‚æœæ•ˆæœä¸ç†æƒ³ï¼Œåˆ†æå“ªäº›ç±»å‹çš„æ ·æœ¬é¢„æµ‹é”™è¯¯
3. **ç»§ç»­è®­ç»ƒ**: å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä»checkpointç»§ç»­è®­ç»ƒ
4. **åº”ç”¨åˆ°å®é™…æ•°æ®**: ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹å¤„ç†æ–°çš„OBBæ•°æ®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `README.md` - è®­ç»ƒæ–‡æ¡£
- `TROUBLESHOOTING.md` - æ•…éšœæ’é™¤
- `train_shape.py` - è®­ç»ƒè„šæœ¬

---

**æœ€åæ›´æ–°**: 2025-11-12

